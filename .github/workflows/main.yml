name: Free Ubuntu VPS with SSH

on:
  workflow_dispatch:

concurrency:
  group: vps-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Update & Install base packages
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            tmux curl ca-certificates git protobuf-compiler git

      - name: Install Rust
        run: |
          set -euxo pipefail
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Build Nexus CLI
        run: |
          set -euxo pipefail
          git clone https://github.com/nexus-xyz/nexus-cli.git
          cd nexus-cli/clients/cli
          cargo build --release
          echo "::notice::Nexus CLI build done!"

      - name: Prepare tmux with 3 Nexus windows
        run: |
          set -euxo pipefail
          # tạo tmux session "nexus" với 3 cửa sổ chạy nexus
          tmux new-session -d -s nexus -n win1 "./nexus-cli/clients/cli/target/release/nexus"
          tmux new-window -t nexus:1 -n win2 "./nexus-cli/clients/cli/target/release/nexus"
          tmux new-window -t nexus:2 -n win3 "./nexus-cli/clients/cli/target/release/nexus"
          tmux ls

      - name: Start SSH (tmate)
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: false
